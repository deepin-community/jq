From: Harlan Lieberman-Berg <hlieberman@debian.org>
Date: Sun, 4 Nov 2018 21:34:10 +0800
Subject: Ensure jq doesn't statically link in libraries

Forwarded: not-needed
---
 Makefile.am | 3 +--
 tests/setup | 2 +-
 2 files changed, 2 insertions(+), 3 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index b29eed2..c762bf0 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -126,11 +126,10 @@ CLEANFILES = src/version.h .remake-version-h src/builtin.inc src/config_opts.inc
 
 bin_PROGRAMS = jq
 jq_SOURCES = src/main.c src/version.h
-jq_LDFLAGS = -static-libtool-libs
 jq_LDADD = libjq.la -lm
 
 if ENABLE_ALL_STATIC
-jq_LDFLAGS += -all-static
+jq_LDFLAGS = -all-static
 endif
 
 ### Tests (make check)
diff --git a/tests/setup b/tests/setup
index c05f4ec..77e2a65 100755
--- a/tests/setup
+++ b/tests/setup
@@ -13,7 +13,7 @@ JQBASEDIR=$JQTESTDIR/..
 JQ=${JQ:-$JQBASEDIR/jq}
 
 if [ -z "${NO_VALGRIND-}" ] && which valgrind > /dev/null; then
-    VALGRIND="valgrind --error-exitcode=1 --leak-check=full \
+    VALGRIND="libtool --mode=execute -- valgrind --error-exitcode=1 --leak-check=full \
                        --suppressions=$JQTESTDIR/onig.supp \
                        --suppressions=$JQTESTDIR/local.supp"
     VG_EXIT0=--error-exitcode=0
