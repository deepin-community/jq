From: =?utf-8?b?IkNoYW5nWmh1byBDaGVuICjpmbPmmIzlgKwpIg==?=
 <czchen@debian.org>
Date: Tue, 8 Jul 2025 00:09:51 +0800
Subject: Fix heap buffer overflow when formatting an empty string

---
 src/jv.c      | 1 +
 tests/jq.test | 4 ++++
 2 files changed, 5 insertions(+)

diff --git a/src/jv.c b/src/jv.c
index a8fbe48..c8e0c51 100644
--- a/src/jv.c
+++ b/src/jv.c
@@ -1121,6 +1121,7 @@ static jv jvp_string_empty_new(uint32_t length) {
   jvp_string* s = jvp_string_alloc(length);
   s->length_hashed = 0;
   memset(s->data, 0, length);
+  s->data[length] = 0;
   jv r = {JVP_FLAGS_STRING, 0, 0, 0, {&s->refcnt}};
   return r;
 }
diff --git a/tests/jq.test b/tests/jq.test
index 944f9da..b36e591 100644
--- a/tests/jq.test
+++ b/tests/jq.test
@@ -2024,6 +2024,10 @@ map(try implode catch .)
 [123,["a"],[nan]]
 ["implode input must be an array","string (\"a\") can't be imploded, unicode codepoint needs to be numeric","number (null) can't be imploded, unicode codepoint needs to be numeric"]
 
+try 0[implode] catch .
+[]
+"Cannot index number with string \"\""
+
 # walk
 walk(.)
 {"x":0}
